// Generated by CoffeeScript 1.6.2
var ResultPageService,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

exports.ResultPageService = ResultPageService = (function() {
  function ResultPageService(app, node_modules, database, req, res, next) {
    this.app = app;
    this.node_modules = node_modules;
    this.database = database;
    this.req = req;
    this.res = res;
    this.next = next;
    this.getNext = __bind(this.getNext, this);
    this.getMovies = __bind(this.getMovies, this);
    this.getDiagnosis = __bind(this.getDiagnosis, this);
    this.async = this.node_modules.async;
    this.eventTable = this.database.eventTable;
    this.movieTable = this.database.movieTable;
    this.eventID = this.req.query.eventID;
    this.pagename = "result";
    this.eventName = "";
    this.introduction = "";
    this.pointText = "";
    this.iconImage = "";
    this.pointImage = "";
    this.introImage = "";
    this.movies = "";
  }

  ResultPageService.prototype.exec = function() {
    return this.async.series([this.getDiagnosis, this.getMovies, this.getNext], function(err, result) {
      if (err) {
        console.log(err);
        throw err;
        res.redirect('/');
      }
      return console.log("all done. " + result);
    });
  };

  ResultPageService.prototype.getDiagnosis = function(callBack) {
    var _this = this;

    return this.eventTable.find({
      where: {
        eventID: this.eventID
      }
    }).success(function(column) {
      _this.eventName = column.name;
      _this.introduction = column.introduction;
      _this.pointText = column.point;
      _this.iconImage = "<img src='/images/" + _this.eventID + "_icon_large.png' alt='event_image' />";
      _this.pointImage = "<img src='/images/" + _this.eventID + "_point.jpg' alt='event_point' />";
      _this.introImage = "<img src='/images/" + _this.eventID + "_intro.jpg' alt='event_intro' />";
      return callBack(null, 1);
    }).error(function(err) {
      return console.log("eventTable getDiagonosisMethod err >> " + err);
    });
  };

  ResultPageService.prototype.getMovies = function(callBack) {
    var _this = this;

    return this.movieTable.findAll({
      where: {
        eventID: this.eventID
      }
    }).success(function(columns) {
      var column, _i, _len;

      for (_i = 0, _len = columns.length; _i < _len; _i++) {
        column = columns[_i];
        _this.movies += "<div class='each-movie" + column.movieID + " col-lg-4'>\n  " + column.url + "\n</div>";
      }
      return callBack(null, 2);
    });
  };

  ResultPageService.prototype.getNext = function(callBack) {
    this.res.render(this.pagename, {
      introduction: this.introduction,
      pointText: this.pointText,
      sportsImage: this.image,
      pointImage: this.pointimage,
      introImage: this.introimage,
      movies: this.movies
    });
    return callBack(null, 3);
  };

  return ResultPageService;

})();

/*
//@ sourceMappingURL=ResultPageService.map
*/
